# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  repository_dispatch:
    types: [backend_automation]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  
  init: 
    runs-on: ubuntu-latest
    steps:
      - uses: derekn/s5cmd-action@v1
        with:
          version: 2.1.0-beta.1
      - name: Init
        run: |
          echo ${{secrets.INIT}} | base64 -d > init.cred
          echo ${{secrets.OUTPUT}} | base64 -d > output.cred
          # s5cmd --credentials-file init.cred --endpoint-url ${{ secrets.S3_ENDPOINT_URL }} ls s3://aria-config
          s5cmd --credentials-file init.cred --endpoint-url ${{ secrets.S3_ENDPOINT_URL }} cp s3://aria-config/dht.dat .

      - name:  Install package
        run: sudo snap install aria2c
        
      # Runs a set of commands using the runners shell
      - name: show Aria2c info
        run: |
          aria2c -v

  set_seed:
    if: github.event_name == 'repository_dispatch'
    needs: init
    steps: 
      - name: dl
        uses: jflulu/dl@v1
        with:
          seed: "${{ github.event.client_payload.seed }}"

  test:
    if: github.event_name == 'repository_dispatch'
    needs: init
    steps: 
      - name: dl
        uses: jflulu/dl@v1
        with:
          seed: magnet:?xt=urn:btih:d984f67af9917b214cd8b6048ab5624c7df6a07a&tr=https%3A%2F%2Facademictorrents.com%2Fannounce.php&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337%2Fannounce
      
            # test:
            #   #if: github.event_name == 'closed'
            #   if: github.event_name != 'repository_dispatch'
            #   with: 
            #     seed: magnet:?xt=urn:btih:d984f67af9917b214cd8b6048ab5624c7df6a07a&tr=https%3A%2F%2Facademictorrents.com%2Fannounce.php&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337%2Fannounce
            #   # Steps represent a sequence of tasks that will be executed as part of the job
            #   steps:
            #     # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
            #     # - uses: actions/checkout@v2
            #     - run: echo $seed

            #     - name: dl
            #       run: |
            #         aria2c  --seed-time=0  -c --dht-file-path=dht.dat "$seed"

  dl:
    steps:
      - run: echo "seed:" "${{ inputs.seed }}"
      - name: dl
        run: |
          timeout aria2c  --seed-time=0 -c --dht-file-path=dht.dat "${{ inputs.seed }}"
          
  final: 
    steps:
      - name: Upload file to bucket
        if: success()
        run: 
          s5cmd --credentials-file init.cred --endpoint-url ${{ secrets.S3_ENDPOINT_URL }} cp dht.dat s3://aria-config/dht.dat 
          s5cmd --credentials-file output.cred --endpoint-url ${{ secrets.S3_ENDPOINT_URL }} cp --exclude dht.dat * s3://aria-config/

